#!/bin/bash

# Выводим информацию о количестве оперативной памяти сервера
echo "Текущая информация о памяти:"
free -h
echo ""

# Отключаем текущий своп
echo "Отключаем текущий своп..."
sudo swapoff -a

# Запрашиваем размер свопа у пользователя
while true; do
    read -p "Введите размер свопа (например, 4G): " SWAP_SIZE

    # Проверяем, что введенное значение является числом или содержит 'G'/'g'
    if [[ $SWAP_SIZE =~ ^[0-9]+$ ]]; then
        SWAP_SIZE="${SWAP_SIZE}G"  # Добавляем G, если введено только число
        break
    elif [[ $SWAP_SIZE =~ ^[0-9]+[Gg]$ ]]; then
        break  # Если уже указана G, просто выходим из цикла
    else
        echo "Неверный формат. Пожалуйста, введите размер, например: 4G или 512."
    fi
done

# Создание своп-файла
echo "Создание своп-файла размером $SWAP_SIZE..."
sudo fallocate -l "$SWAP_SIZE" /swapfile

# Установка правильных разрешений
echo "Установка прав доступа для своп-файла..."
sudo chmod 600 /swapfile

# Инициализация свопа
echo "Инициализация свопа..."
sudo mkswap /swapfile

# Активирование свопа
echo "Активирование своп-файла..."
sudo swapon /swapfile

# Проверка состояния свопа
echo "Проверка состояния свопа..."
sudo swapon --show
free -h

echo "Скрипт выполнен успешно. Своп-файл изменен!"
sleep 1

# Запуск htop для мониторинга
htop
